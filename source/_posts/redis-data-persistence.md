---
title:  Redis数据持久化方案
date: 2020.01.17
tags: 
  - Redis
  
description: Redis的持久化方式（RDB\AOF） 如何开启、关闭
---

### Redis为什么要持久化？

我们知道Redis的数据是保存在内存中，当系统重启或者关闭时，内存中的数据就会被清空
，再也找不回来，而有些时候我们希望就算系统重启，Redis中的数据不会被丢失，于是我们就需要
用到数据的持久化啦。

### Redis怎么实现持久化

**1、** RDB（快照）

RDB方式能够在指定的时间间隔对数据进行快照存储

**2、** AOF（日志）

AOF方式记录每次对服务器的操作，当服务器重启时回重新执行这些命令来恢复原始的数据

**3、** RDB和AOF同时开启

如果两种方式同时开启，redis重启的时候会优先载入AOF文件来恢复原始的数据，在通常
的情况下AOF文件保持的数据要比RDB文件保存的数据完整。

### RDB和AOF优势对比

#### RDB优缺点

> 优点

- RDB是一个非常紧凑的文件，它保存了某个时间点的数据集，非常适用于数据集的备份，可以
每小时保存过去一天的数据，同时每天保存过去一个月的数据，如果除了问题可以根据需求恢复到
不同版本的数据集。

- RDB是一个非常紧凑单一文件，很方便传送到另一个远端数据中心，非常适合用于灾难恢复。

- RDB在保存RDB文件时父进程唯一要做的就是fork一个子进程，接下来的工作全部由子进程来做，
父进程不需要再进行其他IO操作，所以RDB持久化方式可以最大化Redis的性能。

- 与AOF相比，再恢复大的数据集的时候，RDB方式会更快一些。

当Redis需要保存`dump.rdb`文件时，服务器执行一下操作：


- Redis调用forks.同时拥有父进程和子进程。
- 子进程将数据集写入到一个临时的RDB文件中。
- 当子进程完成对新RDB文件写入时，Redis会用新的RDB文件替换原来的RDB文件，并删除旧的RDB文件。


> 缺点

- 如果Redis意外被关闭，可能此时距离下一次备份还有一段时间，在这个期间又
又数据操作，此时就不能完全的保证数据的完整性，可能会丢失部分数据。

- Redis经常fork子进程来保存数据到硬盘上，当数据集比较大时，fork的过程
非常耗时，影响redis响应速度。


#### AOF优缺点

> 优点

- 可以使用不同的fsync策略：无fsync、每秒fsync、使用默认的fsync策略的性能依然很好，
就算出现故障，最多也是丢失1s的数据。

- AOF文件是一个值进行追加的日志文件，不需要写入seek，即使由于某些原因（磁盘空间已满
，写的过程宕机等）未执行的写入命令，也可以使用redis-check-aof工具修复这些问题。

- Redis可以在AOF文件体积变得比较大时，自动的在后台对AOF进行重写:重写后的新AOF
文件包含了恢复当前数据集的最小命令集合。整个重写操作时绝对安全的，因为Redis在
创建新AOF文件的过程中，会继续将命令追加到现有的AOF文件里，即使重写过程中停机，
现有的AOF文件也不会丢失。而一旦新AOF文件船舰完毕，Redis就会从旧的AOF文件切换到新的
AOF文件，并开始对新AOF文件进行追加操作。

> 缺点

AOF的文件提及比较大，而由于保存频率很高，所以整体的速度会比
RDB慢一些，但是性能依旧很强。


### 工作原理

![RDB](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMC8yMS8xNjY5NjE2NmFhZDhkNTY4?x-oss-process=image/format,png)

![AOF](https://user-gold-cdn.xitu.io/2018/10/21/1669616cfe85ff1b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

AOF重写和RDB创建快照一样，都巧妙的利用了写时复制机制：

- Redis执行fork()，现在同时拥有父子进程。

- 子进程开始将新的AOF文件写入到临时文件。

- 对于所有新执行的写入命令，父进程一边将他们累积到一个内存缓存中，一边将这些改动的追加到
现有AOF文件的末尾，这样即使中途宕机，现有的AOF文件也还是安全的。

- 当子进程完成重写工作时，它给父进程一个信号，父进程接收到信号之后，将内存缓存中
的所有数据最佳到新的AOF文件的末尾。

- 现有Redis原子的用新文件替换旧文件，之后所有的命令都会直接追加到新AOF文件的末尾。

### RDB持久化方式的开启与配置

Redis默认的持久化方式就是RDB，默认也是打开的。RDB的保存方式分为主动保存和
被动保存。主动保存可以在redis-cli中输入`save`即可。被动保存需要满足配置文件
中设定的触发条件，目前官方默认的触发条件可以在`redis.conf`中看到：


#### 被动保存

```
save 900 1 
save 300 10
save 60 10000
```

 **命令含义**
```
服务器在900s内，对数据进行了至少1次修改
服务器在300s内，对数据进行了至少10次修改
服务器在60s之内，对数据库进行了至少10000次修改
```

满足触发条件后，数据就会被保存为快照，会在指定的目录生产一个`dump.rdb`的文件，
等到下一次启动Redis时，Redis就会去读取该目录下的`dump.rdb`文件，将里面的数据
恢复到Redis,就因为时间间隔的缘故所以说RDB的数据完整性比不上AOF。

#### 主动保存

> save和bgsave

Redis提供了`save`和`bgsave`这两种不同的主动保存命令，`save`命令会阻塞Redis主进程
，知道保存完成位置。在阻塞期间，服务器不能处理任何客户端的请求。`bgsave` 则时fourk
出一个子进程，子进程负责对数据的保存，不会阻塞主进程。最大的区别就是`save`是同步的
操作，`bgsave`是异步操作。

### AOF持久化方式的开启与配置

Redis默认是不开启AOF的，如果想启动则需要修改`redis.conf`配置文件中开启,将配置文件
中的`appendonly`属性改为yes,默认是no。

- 设置同步方式（默认everysec）
```jshelllanguage
appendfsync always  # 每次有数据修改发生时都会写入AOF文件（安全但是费时）。
appendfsync everysec  # 每秒钟同步一次，该策略为AOF的缺省策略。
appendfsync no  # 从不同步。高效但是数据不会被持久化。
```

### RDB和AOF方式切换

- 重启的方式：手动修改配置文件，将Redis被动触发快照注释掉，就是上面列举出来的
三条命令，然后将save '' 的注释打开。 并将`appendonly` 改为yes。

- 不重启命令方式：
```
redis-cli config set appendonly yes

redis-cli config set save "" 
```
需要注意的一个地方：需要在`redis.conf`文件中将AOF功能打开，否则服务器重启，该命令
不会被记录到aof日志文件中，程序就还会按照原来的配置启动服务器。
